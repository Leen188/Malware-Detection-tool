import os
import csv
import pandas as pd
import joblib

class PDFAnalyzer:
    def analyze(self, file_path):
        # Analyze PDF with pdfid
        command = f'python.exe  pdfid.py "{file_path}"'
        output = os.popen(command).read()
        pdf_dict = {}
        lines = output.split('\n')
        for line in lines:
            words = line.split()
            if len(words) >= 2:
                if words[0] == '/Colors' and words[1] == '>':
                    pdf_dict[words[0].replace('/', '')] = 2**24
                else:
                    pdf_dict[words[0].replace('/', '')] = words[1]

        # Convert dictionary to CSV
        csv_file_path = 'Files.csv'
        keys = ['obj', 'endobj', 'stream', 'endstream', 'xref', 'trailer', 'startxref',
                'Page', 'Encrypt', 'ObjStm', 'JS', 'JavaScript', 'AA', 'OpenAction', 'AcroForm',
                'JBIG2Decode', 'RichMedia', 'Launch', 'EmbeddedFile', 'XFA', 'Colors']
        with open(csv_file_path, 'w') as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames=keys)
            writer.writeheader()
            writer.writerow({k: pdf_dict[k] for k in keys if k in pdf_dict})

        # Load the data from the CSV file
        data = pd.read_csv('base\Files.csv')

        # Load the model from the file and make predictions
        svm_model = joblib.load('base/ML/File/svm_model.joblib')
        predictions = svm_model.predict(data.values)

        # Check the prediction result
        if predictions[0] == 'no':
            return "The file is safe"
        elif predictions[0] == 'yes':
            return "The file is malicious"
